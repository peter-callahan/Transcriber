<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Organizer & OCR</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .upload-area { border: 2px dashed #ddd; border-radius: 8px; padding: 40px; text-align: center; margin: 20px 0; background: white; }
        .upload-area.dragover { border-color: #007bff; background: #f8f9fa; }
        .btn { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; font-size: 14px; }
        .btn:hover { background: #0056b3; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #218838; }
        .btn-secondary { background: #6c757d; }
        .btn-secondary:hover { background: #5a6268; }
        
        .uploaded-images { background: white; border-radius: 8px; padding: 20px; margin: 20px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .images-container { display: flex; flex-wrap: wrap; gap: 15px; margin: 20px 0; }
        .image-item { position: relative; border: 2px solid transparent; border-radius: 8px; overflow: hidden; cursor: pointer; transition: all 0.2s; }
        .image-item:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .image-item:hover .preview-btn { opacity: 1; }
        .image-item.selected { border-color: #007bff; }
        .image-item img { width: 120px; height: 120px; object-fit: cover; display: block; }
        .image-item .checkbox { position: absolute; top: 5px; right: 5px; }
        .image-item .group-badge { position: absolute; top: 5px; left: 5px; background: #007bff; color: white; padding: 2px 6px; border-radius: 10px; font-size: 12px; }
        .image-item .preview-btn { position: absolute; bottom: 5px; right: 5px; background: rgba(0,0,0,0.7); color: white; border: none; border-radius: 50%; width: 28px; height: 28px; cursor: pointer; opacity: 0; transition: opacity 0.2s; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .image-item .preview-btn:hover { background: rgba(0,0,0,0.9); }
        
        .groups-section { background: white; border-radius: 8px; padding: 20px; margin: 20px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .groups-list { display: flex; flex-wrap: wrap; gap: 20px; margin: 20px 0; }
        .group-card { border: 2px solid #ddd; border-radius: 8px; padding: 15px; min-width: 250px; min-height: 120px; }
        .group-card.drag-over { border-color: #28a745; background: #d4edda; }
        .group-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .group-name { font-weight: bold; font-size: 16px; }
        .group-count { color: #666; font-size: 12px; }
        .group-images { display: flex; flex-wrap: wrap; gap: 5px; }
        .group-images img { width: 40px; height: 40px; object-fit: cover; border-radius: 4px; }
        
        .image-item.dragging { opacity: 0.5; transform: rotate(5deg); }
        .batch-group-creation { background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 10px 0; }
        .group-input-row { display: flex; align-items: center; gap: 10px; margin: 5px 0; }
        .group-input-row input { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .group-input-row button { padding: 6px 12px; }
        
        .controls { text-align: center; margin: 20px 0; }
        .controls input { padding: 8px; margin: 0 10px; border: 1px solid #ddd; border-radius: 4px; }
        
        .processing-status { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 15px; border-radius: 4px; margin: 20px 0; }
        .processing-status.success { background: #d4edda; border-color: #c3e6cb; color: #155724; }
        .processing-status.error { background: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        
        .config-section { background: white; border-radius: 8px; padding: 20px; margin: 20px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .form-group { margin: 10px 0; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        
        .hidden { display: none; }
        
        /* Modal styles */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; z-index: 1000; }
        .modal-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 8px; padding: 20px; min-width: 300px; max-width: 500px; }
        .modal-header { font-size: 18px; font-weight: bold; margin-bottom: 15px; }
        .modal-body { margin-bottom: 20px; }
        .modal-footer { display: flex; gap: 10px; justify-content: flex-end; }
        
        /* Image preview modal */
        .image-preview-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; z-index: 1001; cursor: pointer; }
        .image-preview-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); max-width: 90vw; max-height: 90vh; }
        .image-preview-content img { max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        .image-preview-close { position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; }
        .image-preview-close:hover { background: rgba(255,255,255,0.3); }
        .image-preview-title { position: absolute; bottom: 20px; left: 20px; color: white; background: rgba(0,0,0,0.7); padding: 8px 12px; border-radius: 4px; font-size: 14px; }
        
        /* Progress bar styles */
        .progress-container { background: white; border-radius: 8px; padding: 20px; margin: 20px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: none; }
        .progress-header { font-size: 18px; font-weight: bold; margin-bottom: 15px; text-align: center; }
        .progress-bar-track { background: #f0f0f0; border-radius: 10px; height: 20px; position: relative; overflow: hidden; }
        .progress-bar-fill { background: linear-gradient(90deg, #007bff, #28a745); height: 100%; width: 0%; transition: width 0.5s ease-in-out; border-radius: 10px; position: relative; }
        .progress-bar-fill::after { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent); animation: shimmer 2s infinite; }
        @keyframes shimmer { 0% { left: -100%; } 100% { left: 100%; } }
        .progress-percentage { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: bold; color: #333; font-size: 12px; }
        .progress-steps { display: flex; justify-content: space-between; margin-top: 15px; }
        .progress-step { text-align: center; flex: 1; padding: 0 5px; }
        .progress-step-icon { width: 30px; height: 30px; border-radius: 50%; background: #ddd; color: #666; display: flex; align-items: center; justify-content: center; margin: 0 auto 8px; font-size: 16px; transition: all 0.3s; }
        .progress-step.active .progress-step-icon { background: #007bff; color: white; }
        .progress-step.completed .progress-step-icon { background: #28a745; color: white; }
        .progress-step-label { font-size: 12px; color: #666; }
        .progress-step.active .progress-step-label { color: #007bff; font-weight: bold; }
        .progress-step.completed .progress-step-label { color: #28a745; }
        
        /* Inline editing styles */
        .group-name-editable { cursor: pointer; padding: 2px 4px; border-radius: 4px; }
        .group-name-editable:hover { background: #f0f0f0; }
        .group-name-input { border: 2px solid #007bff; padding: 2px 4px; border-radius: 4px; font-weight: bold; font-size: 16px; }
        .edit-name-btn { font-size: 12px; padding: 2px 6px; margin-left: 5px; }
        
        @media (max-width: 768px) {
            .images-container { justify-content: center; }
            .groups-list { flex-direction: column; }
            .modal-content { margin: 20px; width: calc(100% - 40px); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Photo Organizer & OCR</h1>
            <p>Upload photos, group them visually, then process with OCR and AI transcription</p>
        </div>

        <!-- Upload Section -->
        <div class="upload-area" id="uploadArea">
            <div>
                <h3>Drop photos here or click to select</h3>
                <input type="file" id="fileInput" multiple accept="image/*" style="display: none;">
                <button class="btn" onclick="event.stopPropagation(); document.getElementById('fileInput').click()">Choose Files</button>
            </div>
        </div>

        <!-- Uploaded Images Section -->
        <div class="uploaded-images" id="uploadedImagesSection" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3>Uploaded Images</h3>
                <div>
                    <button class="btn btn-secondary" onclick="selectAll()">Select All</button>
                    <button class="btn btn-secondary" onclick="selectNone()">Select None</button>
                    <button class="btn btn-danger" onclick="clearAllImages()">Clear All</button>
                </div>
            </div>
            <div class="images-container" id="imagesContainer"></div>
        </div>

        <!-- Grouping Controls -->
        <div class="controls" id="groupingControls" style="display: none;">
            <button class="btn" onclick="createSingleGroup()">Put All Images in One Group</button>
            <button class="btn btn-secondary" onclick="showBatchGroupCreation()">Create Multiple Groups</button>
        </div>

        <!-- Batch Group Creation -->
        <div class="batch-group-creation" id="batchGroupCreation" style="display: none;">
            <h4>Create Multiple Groups</h4>
            <div id="groupInputsList">
                <div class="group-input-row">
                    <input type="text" placeholder="Group name" class="group-name-input">
                    <button class="btn btn-danger" onclick="removeGroupInput(this)">Remove</button>
                </div>
            </div>
            <div style="text-align: center; margin: 15px 0;">
                <button class="btn btn-secondary" onclick="addGroupInput()">Add Another Group</button>
                <button class="btn btn-success" onclick="createMultipleGroups()">Create All Groups</button>
                <button class="btn" onclick="hideBatchGroupCreation()">Cancel</button>
            </div>
        </div>

        <!-- Groups Section -->
        <div class="groups-section" id="groupsSection" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3>Image Groups</h3>
                <div>
                    <button class="btn" onclick="addSingleGroup()">+ Add Another Group</button>
                    <button class="btn btn-danger" onclick="clearAllGroups()">Clear All Groups</button>
                </div>
            </div>
            <div class="groups-list" id="groupsList"></div>
        </div>

        <!-- Processing Section -->
        <div class="controls">
            <button class="btn btn-success" onclick="processGroups()" style="font-size: 18px; padding: 15px 30px;">
                üöÄ Process All Groups
            </button>
        </div>

        <!-- Progress Bar -->
        <div class="progress-container" id="progressContainer">
            <div class="progress-header" id="progressHeader">Processing Groups...</div>
            <div class="progress-bar-track">
                <div class="progress-bar-fill" id="progressBarFill"></div>
                <div class="progress-percentage" id="progressPercentage">0%</div>
            </div>
            <div class="progress-steps">
                <div class="progress-step" id="step1">
                    <div class="progress-step-icon">üìÅ</div>
                    <div class="progress-step-label">Organizing</div>
                </div>
                <div class="progress-step" id="step2">
                    <div class="progress-step-icon">üñºÔ∏è</div>
                    <div class="progress-step-label">Processing Images</div>
                </div>
                <div class="progress-step" id="step3">
                    <div class="progress-step-icon">üëÅÔ∏è</div>
                    <div class="progress-step-label">OCR Extraction</div>
                </div>
                <div class="progress-step" id="step4">
                    <div class="progress-step-icon">ü§ñ</div>
                    <div class="progress-step-label">AI Processing</div>
                </div>
                <div class="progress-step" id="step5">
                    <div class="progress-step-icon">‚úÖ</div>
                    <div class="progress-step-label">Complete</div>
                </div>
            </div>
        </div>

        <!-- Status Section -->
        <div id="statusSection"></div>

        <!-- Configuration -->
        <div class="config-section">
            <h3>Configuration</h3>
            <div class="form-group">
                <label>Output Folder:</label>
                <input type="text" id="outputFolder" value="./markdown_output">
            </div>
            <button class="btn" onclick="updateConfig()">Update Config</button>
        </div>
    </div>

    <!-- Modal Dialog -->
    <div class="modal-overlay" id="modalOverlay" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header" id="modalHeader">Confirm</div>
            <div class="modal-body" id="modalBody">Are you sure?</div>
            <div class="modal-footer" id="modalFooter">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-danger" onclick="confirmModal()">OK</button>
            </div>
        </div>
    </div>

    <!-- Image Preview Modal -->
    <div class="image-preview-overlay" id="imagePreviewOverlay" onclick="closeImagePreview()">
        <button class="image-preview-close" onclick="closeImagePreview()">√ó</button>
        <div class="image-preview-content">
            <img id="previewImage" src="" alt="">
            <div class="image-preview-title" id="previewTitle"></div>
        </div>
    </div>

    <script>
        let uploadedImages = [];
        let imageGroups = [];

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadConfig();
            setupUploadHandlers();
        });

        function setupUploadHandlers() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            // Drag and drop
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });

            // File input change
            fileInput.addEventListener('change', function(e) {
                handleFiles(e.target.files);
            });

            // Click to open file dialog
            uploadArea.addEventListener('click', function() {
                fileInput.click();
            });
        }

        function handleFiles(files) {
            const formData = new FormData();
            for (let file of files) {
                formData.append('files', file);
            }

            fetch('/api/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.files) {
                    uploadedImages = [...uploadedImages, ...data.files.map(f => ({...f, selected: false, groupId: null}))];
                    displayImages();
                    showSection('uploadedImagesSection');
                    showSection('groupingControls');
                }
            })
            .catch(error => {
                console.error('Upload error:', error);
                showStatus('Upload failed', 'error');
            });
        }

        function displayImages() {
            const container = document.getElementById('imagesContainer');
            container.innerHTML = '';

            uploadedImages.forEach((image, index) => {
                const div = document.createElement('div');
                div.className = `image-item ${image.selected ? 'selected' : ''}`;
                div.draggable = true;
                div.dataset.imageIndex = index;
                div.innerHTML = `
                    <img src="${image.path}" alt="${image.name}">
                    <input type="checkbox" class="checkbox" ${image.selected ? 'checked' : ''} 
                           onchange="toggleImageSelection(${index})">
                    <button class="preview-btn" onclick="event.stopPropagation(); showImagePreview('${image.path}', '${image.name}')">üëÅÔ∏è</button>
                    ${image.groupId !== null ? `<div class="group-badge">G${image.groupId + 1}</div>` : ''}
                `;
                div.onclick = (e) => {
                    if (e.target.type !== 'checkbox') {
                        toggleImageSelection(index);
                    }
                };
                
                // Add drag event listeners
                div.addEventListener('dragstart', handleImageDragStart);
                div.addEventListener('dragend', handleImageDragEnd);
                
                container.appendChild(div);
            });
        }

        function toggleImageSelection(index) {
            uploadedImages[index].selected = !uploadedImages[index].selected;
            displayImages();
        }

        function selectAll() {
            uploadedImages.forEach(img => img.selected = true);
            displayImages();
        }

        function selectNone() {
            uploadedImages.forEach(img => img.selected = false);
            displayImages();
        }

        function getSelectedImages() {
            return uploadedImages.filter(img => img.selected);
        }

        function createSingleGroup() {
            if (uploadedImages.length === 0) {
                showModal('No Images', 'Please upload images first', 'OK', false);
                return;
            }

            const groupName = `Group ${imageGroups.length + 1}`;
            const newGroup = {
                id: imageGroups.length,
                name: groupName,
                images: uploadedImages.map(img => img.name)
            };

            // Update all image group assignments
            uploadedImages.forEach((img, index) => {
                uploadedImages[index].groupId = newGroup.id;
                uploadedImages[index].selected = false;
            });

            imageGroups.push(newGroup);
            
            displayImages();
            displayGroups();
            showSection('groupsSection');
        }


        function displayGroups() {
            const container = document.getElementById('groupsList');
            container.innerHTML = '';

            imageGroups.forEach((group, index) => {
                const div = document.createElement('div');
                div.className = 'group-card';
                div.dataset.groupIndex = index;
                div.innerHTML = `
                    <div class="group-header">
                        <span class="group-name group-name-editable" onclick="startEditGroupName(${index})" id="groupName${index}">${group.name}</span>
                        <div>
                            <button class="btn btn-secondary edit-name-btn" onclick="startEditGroupName(${index})">‚úèÔ∏è</button>
                            <span class="group-count">${group.images.length} images</span>
                            <button class="btn btn-danger" onclick="deleteGroup(${index})" style="padding: 2px 8px; margin-left: 5px;">√ó</button>
                        </div>
                    </div>
                    <div class="group-images">
                        ${group.images.map(imgName => {
                            const img = uploadedImages.find(ui => ui.name === imgName);
                            return img ? `<img src="${img.path}" alt="${imgName}">` : '';
                        }).join('')}
                    </div>
                `;
                // No onclick for group selection needed anymore
                
                // Add drop event listeners to groups
                div.addEventListener('dragover', handleGroupDragOver);
                div.addEventListener('dragleave', handleGroupDragLeave);
                div.addEventListener('drop', handleGroupDrop);
                
                container.appendChild(div);
            });
        }


        async function deleteGroup(groupId) {
            const confirmed = await showModal('Delete Group', `Delete ${imageGroups[groupId].name}?`, 'Delete', true);
            if (!confirmed) return;

            // Remove group assignment from images
            uploadedImages.forEach(img => {
                if (img.groupId === groupId) {
                    img.groupId = null;
                } else if (img.groupId > groupId) {
                    img.groupId -= 1;
                }
            });

            imageGroups.splice(groupId, 1);
            
            // Update group IDs
            imageGroups.forEach((group, index) => {
                group.id = index;
            });

            displayImages();
            displayGroups();

            if (imageGroups.length === 0) {
                hideSection('groupsSection');
            }
        }

        async function clearAllImages() {
            const confirmed = await showModal('Clear All Images', 'Clear all uploaded images?', 'Clear', true);
            if (!confirmed) return;

            fetch('/api/clear_temp', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                uploadedImages = [];
                imageGroups = [];
                hideSection('uploadedImagesSection');
                hideSection('groupingControls');
                hideSection('groupsSection');
                showStatus('All images cleared', 'success');
            })
            .catch(error => {
                console.error('Clear error:', error);
                showStatus('Failed to clear images', 'error');
            });
        }

        async function clearAllGroups() {
            const confirmed = await showModal('Clear All Groups', 'Clear all groups? (Images will remain uploaded)', 'Clear', true);
            if (!confirmed) return;

            uploadedImages.forEach(img => {
                img.groupId = null;
                img.selected = false;
            });
            imageGroups = [];

            displayImages();
            hideSection('groupsSection');
        }

        function processGroups() {
            if (imageGroups.length === 0) {
                showModal('No Groups', 'Please create at least one group before processing', 'OK', false);
                return;
            }

            processWithProgress();
        }

        function loadConfig() {
            fetch('/api/config')
            .then(response => response.json())
            .then(data => {
                document.getElementById('outputFolder').value = data.output_folder || './markdown_output';
            })
            .catch(error => {
                console.error('Load config error:', error);
            });
        }

        function updateConfig() {
            const config = {
                output_folder: document.getElementById('outputFolder').value
            };

            fetch('/api/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                showStatus('Configuration updated', 'success');
            })
            .catch(error => {
                console.error('Update config error:', error);
                showStatus('Failed to update configuration', 'error');
            });
        }

        function showSection(sectionId) {
            document.getElementById(sectionId).style.display = 'block';
        }

        function hideSection(sectionId) {
            document.getElementById(sectionId).style.display = 'none';
        }

        function showStatus(message, type = 'info') {
            const statusSection = document.getElementById('statusSection');
            statusSection.innerHTML = `<div class="processing-status ${type}">${message}</div>`;
            
            // Auto-hide after 5 seconds for success messages
            if (type === 'success') {
                setTimeout(() => {
                    statusSection.innerHTML = '';
                }, 5000);
            }
        }

        // Batch group creation functions
        function showBatchGroupCreation() {
            const container = document.getElementById('groupInputsList');
            // Default to 2 groups
            container.innerHTML = `
                <div class="group-input-row">
                    <input type="text" placeholder="Group name" class="group-name-input" value="Group ${imageGroups.length + 1}">
                    <button class="btn btn-danger" onclick="removeGroupInput(this)">Remove</button>
                </div>
                <div class="group-input-row">
                    <input type="text" placeholder="Group name" class="group-name-input" value="Group ${imageGroups.length + 2}">
                    <button class="btn btn-danger" onclick="removeGroupInput(this)">Remove</button>
                </div>
            `;
            document.getElementById('batchGroupCreation').style.display = 'block';
        }

        function hideBatchGroupCreation() {
            document.getElementById('batchGroupCreation').style.display = 'none';
            // Reset to single input
            const container = document.getElementById('groupInputsList');
            container.innerHTML = `
                <div class="group-input-row">
                    <input type="text" placeholder="Group name" class="group-name-input">
                    <button class="btn btn-danger" onclick="removeGroupInput(this)">Remove</button>
                </div>
            `;
        }

        function addGroupInput() {
            const container = document.getElementById('groupInputsList');
            const nextGroupNumber = imageGroups.length + container.children.length + 1;
            const div = document.createElement('div');
            div.className = 'group-input-row';
            div.innerHTML = `
                <input type="text" placeholder="Group name" class="group-name-input" value="Group ${nextGroupNumber}">
                <button class="btn btn-danger" onclick="removeGroupInput(this)">Remove</button>
            `;
            container.appendChild(div);
        }

        function removeGroupInput(button) {
            const container = document.getElementById('groupInputsList');
            if (container.children.length > 1) {
                button.parentElement.remove();
            } else {
                showModal('Cannot Remove', 'At least one group is required', 'OK', false);
            }
        }

        function createMultipleGroups() {
            const inputs = document.querySelectorAll('.group-name-input');
            const groupNames = Array.from(inputs).map(input => input.value.trim()).filter(name => name);
            
            if (groupNames.length === 0) {
                showModal('No Group Names', 'Please enter at least one group name', 'OK', false);
                return;
            }

            // Check for duplicate names
            const uniqueNames = [...new Set(groupNames)];
            if (uniqueNames.length !== groupNames.length) {
                showModal('Duplicate Names', 'Group names must be unique', 'OK', false);
                return;
            }

            // Create all groups
            groupNames.forEach(name => {
                const newGroup = {
                    id: imageGroups.length,
                    name: name,
                    images: []
                };
                imageGroups.push(newGroup);
            });

            displayGroups();
            showSection('groupsSection');
            hideBatchGroupCreation();
            showStatus(`Created ${groupNames.length} groups`, 'success');
        }

        // Drag and drop functions
        let draggedImageIndex = null;

        function handleImageDragStart(e) {
            draggedImageIndex = parseInt(e.target.closest('.image-item').dataset.imageIndex);
            e.target.closest('.image-item').classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleImageDragEnd(e) {
            e.target.closest('.image-item').classList.remove('dragging');
            draggedImageIndex = null;
        }

        function handleGroupDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            e.currentTarget.classList.add('drag-over');
        }

        function handleGroupDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        function handleGroupDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            
            if (draggedImageIndex === null) return;
            
            const groupIndex = parseInt(e.currentTarget.dataset.groupIndex);
            const image = uploadedImages[draggedImageIndex];
            
            // Remove image from current group if it's in one
            if (image.groupId !== null) {
                const currentGroup = imageGroups[image.groupId];
                const imgIndex = currentGroup.images.indexOf(image.name);
                if (imgIndex > -1) {
                    currentGroup.images.splice(imgIndex, 1);
                }
            }
            
            // Add image to new group
            image.groupId = groupIndex;
            if (!imageGroups[groupIndex].images.includes(image.name)) {
                imageGroups[groupIndex].images.push(image.name);
            }
            
            displayImages();
            displayGroups();
            showStatus(`Moved image to ${imageGroups[groupIndex].name}`, 'success');
        }

        // Single group creation function
        function addSingleGroup() {
            const groupName = `Group ${imageGroups.length + 1}`;
            
            const newGroup = {
                id: imageGroups.length,
                name: groupName,
                images: []
            };
            
            imageGroups.push(newGroup);
            displayGroups();
            showStatus(`Created "${groupName}"`, 'success');
        }

        // Inline group name editing
        function startEditGroupName(groupIndex) {
            const nameSpan = document.getElementById(`groupName${groupIndex}`);
            const currentName = imageGroups[groupIndex].name;
            
            // Replace span with input
            nameSpan.innerHTML = `<input type="text" class="group-name-input" value="${currentName}" 
                                 onblur="finishEditGroupName(${groupIndex}, this)" 
                                 onkeypress="if(event.key==='Enter') finishEditGroupName(${groupIndex}, this)"
                                 id="editInput${groupIndex}">`;
            
            // Focus and select the input
            const input = document.getElementById(`editInput${groupIndex}`);
            input.focus();
            input.select();
        }

        function finishEditGroupName(groupIndex, inputElement) {
            const newName = inputElement.value.trim();
            const nameSpan = document.getElementById(`groupName${groupIndex}`);
            
            if (newName && newName !== imageGroups[groupIndex].name) {
                // Check for duplicate names
                if (imageGroups.some((group, idx) => idx !== groupIndex && group.name === newName)) {
                    showStatus('A group with this name already exists', 'error');
                    // Restore original name
                    nameSpan.textContent = imageGroups[groupIndex].name;
                    return;
                }
                
                // Update the group name
                imageGroups[groupIndex].name = newName;
                showStatus(`Renamed to "${newName}"`, 'success');
            }
            
            // Restore the span
            nameSpan.textContent = imageGroups[groupIndex].name;
            nameSpan.className = 'group-name group-name-editable';
            nameSpan.onclick = () => startEditGroupName(groupIndex);
        }

        // Modal functions
        let modalCallback = null;

        function showModal(title, message, confirmText = 'OK', isConfirm = true) {
            return new Promise((resolve) => {
                document.getElementById('modalHeader').textContent = title;
                document.getElementById('modalBody').textContent = message;
                
                const footer = document.getElementById('modalFooter');
                if (isConfirm) {
                    footer.innerHTML = `
                        <button class="btn btn-secondary" onclick="closeModal(false)">Cancel</button>
                        <button class="btn btn-danger" onclick="closeModal(true)">${confirmText}</button>
                    `;
                } else {
                    footer.innerHTML = `
                        <button class="btn" onclick="closeModal(true)">OK</button>
                    `;
                }
                
                modalCallback = resolve;
                document.getElementById('modalOverlay').style.display = 'block';
            });
        }

        function closeModal(result = false) {
            document.getElementById('modalOverlay').style.display = 'none';
            if (modalCallback) {
                modalCallback(result);
                modalCallback = null;
            }
        }

        // Image preview functions
        function showImagePreview(imagePath, imageName) {
            document.getElementById('previewImage').src = imagePath;
            document.getElementById('previewTitle').textContent = imageName;
            document.getElementById('imagePreviewOverlay').style.display = 'block';
        }

        function closeImagePreview() {
            document.getElementById('imagePreviewOverlay').style.display = 'none';
        }

        // Close preview on Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeImagePreview();
            }
        });

        // Progress bar functions
        function showProgressBar() {
            document.getElementById('progressContainer').style.display = 'block';
            resetProgress();
        }

        function hideProgressBar() {
            document.getElementById('progressContainer').style.display = 'none';
        }

        function resetProgress() {
            document.getElementById('progressBarFill').style.width = '0%';
            document.getElementById('progressPercentage').textContent = '0%';
            
            // Reset all steps
            for (let i = 1; i <= 5; i++) {
                const step = document.getElementById(`step${i}`);
                step.classList.remove('active', 'completed');
            }
        }

        function updateProgress(step, percentage, message) {
            // Update progress bar
            document.getElementById('progressBarFill').style.width = percentage + '%';
            document.getElementById('progressPercentage').textContent = percentage + '%';
            document.getElementById('progressHeader').textContent = message;

            // Update step indicators
            for (let i = 1; i <= 5; i++) {
                const stepElement = document.getElementById(`step${i}`);
                stepElement.classList.remove('active', 'completed');
                
                if (i < step) {
                    stepElement.classList.add('completed');
                } else if (i === step) {
                    stepElement.classList.add('active');
                }
            }
        }

        async function processWithProgress() {
            showProgressBar();
            
            try {
                // Step 1: Organizing (0-20%)
                updateProgress(1, 10, 'Organizing groups...');
                await new Promise(resolve => setTimeout(resolve, 500));

                // Send the request
                const response = await fetch('/api/process', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ groups: imageGroups })
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                // Step 2: Processing Images (20-40%)
                updateProgress(2, 30, 'Processing images...');
                await new Promise(resolve => setTimeout(resolve, 1000));

                // Step 3: OCR Extraction (40-70%)
                updateProgress(3, 55, 'Extracting text with OCR...');
                await new Promise(resolve => setTimeout(resolve, 2000));

                // Step 4: AI Processing (70-90%)
                updateProgress(4, 80, 'AI transcription in progress...');
                await new Promise(resolve => setTimeout(resolve, 1500));

                // Get the final result
                const data = await response.json();

                // Step 5: Complete (100%)
                updateProgress(5, 100, 'Processing complete!');
                await new Promise(resolve => setTimeout(resolve, 500));

                if (data.message) {
                    showStatus(data.message, 'success');
                    // Clear everything after successful processing
                    uploadedImages = [];
                    imageGroups = [];
                    hideSection('uploadedImagesSection');
                    hideSection('groupingControls');
                    hideSection('groupsSection');
                    
                    // Hide progress bar after a delay
                    setTimeout(() => {
                        hideProgressBar();
                    }, 2000);
                } else if (data.error) {
                    throw new Error(data.error);
                }

            } catch (error) {
                console.error('Process error:', error);
                showStatus(`Processing failed: ${error.message}`, 'error');
                hideProgressBar();
            }
        }
    </script>
</body>
</html>